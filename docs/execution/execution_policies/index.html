<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/bazel-buildfarm/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/bazel-buildfarm/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/bazel-buildfarm/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/bazel-buildfarm/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Policies | Buildfarm</title><meta name="generator" content="Jekyll v4.1.1" /><meta property="og:title" content="Policies" /><meta property="og:locale" content="en_US" /><meta name="description" content="Remote Execution for Bazel" /><meta property="og:description" content="Remote Execution for Bazel" /><link rel="canonical" href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_policies/" /><meta property="og:url" content="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_policies/" /><meta property="og:site_name" content="Buildfarm" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Policies" /> <script type="application/ld+json"> {"url":"https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_policies/","description":"Remote Execution for Bazel","@type":"WebPage","headline":"Policies","@context":"https://schema.org"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <img src="https://bazelbuild.github.io/bazel-buildfarm/assets/images/bazel-logo.png" alt="bazel logo" style="width:53px"> <a href="https://bazelbuild.github.io/bazel-buildfarm/" class="site-title lh-tight"> Buildfarm </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="https://bazelbuild.github.io/bazel-buildfarm/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/features/" class="nav-list-link">Features</a><li class="nav-list-item"><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/quick_start/" class="nav-list-link">Quick Start</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/architecture/" class="nav-list-link">Architecture</a><ul class="nav-list "><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/instance_types/" class="nav-list-link">Instance Types</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/workers/" class="nav-list-link">Workers</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/schedulers/" class="nav-list-link">Schedulers</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/worker-execution-environment/" class="nav-list-link">Workers</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/queues/" class="nav-list-link">Queues</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/action_cache/" class="nav-list-link">Action Cache</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/CASFileCache/" class="nav-list-link">CASFileCache</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/content_addressable_storage/" class="nav-list-link">CAS</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/architecture/redis/" class="nav-list-link">Redis</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution/" class="nav-list-link">Execution</a><ul class="nav-list "><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/debugging-executions/" class="nav-list-link">Debugging</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/environment/" class="nav-list-link">Enviornment</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/exec_owner/" class="nav-list-link">Owner</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_limiting/" class="nav-list-link">Limiting</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/builds-without-the-bytes/" class="nav-list-link">Build Without Bytes</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_properties/" class="nav-list-link">Properties</a><li class="nav-list-item active"><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution_policies/" class="nav-list-link active">Policies</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/metrics/metrics/" class="nav-list-link">Metrics</a><ul class="nav-list "><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/metrics/alerts/" class="nav-list-link">Alerts</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/tools/tools/" class="nav-list-link">Tools</a><ul class="nav-list "><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/tools/troubleshooting-bazel-remote-execution/" class="nav-list-link">Troubleshooting</a><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/tools/bf-cat/" class="nav-list-link">bf-cat</a></ul><li class="nav-list-item"><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/admin/" class="nav-list-link">Admin</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/contribute/contribute/" class="nav-list-link">Contribute</a><ul class="nav-list "><li class="nav-list-item "><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/contribute/design-documents/" class="nav-list-link">Design Documents</a></ul></ul></nav><footer class="site-footer"></footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Buildfarm" aria-label="Search Buildfarm" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://github.com/bazelbuild/bazel-buildfarm" class="site-button" > GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="https://bazelbuild.github.io/bazel-buildfarm/docs/execution/execution/">Execution</a><li class="breadcrumb-nav-list-item"><span>Policies</span></ol></nav><div id="main-content" class="main-content" role="main"><p>Execution Policies can be defined to modify or control Action execution on workers. A given policy can be assigned a name, with a policy with a default name (the empty string) affecting all executions on a worker, as well as a single type of modifier.</p><p>Policies are applied in order of definition for a single matching name, with the default policies applied first, followed by the order specified effective by the action.</p><h2 id="wrapper-execution-policy-modifier-type"> <a href="#wrapper-execution-policy-modifier-type" class="anchor-heading" aria-labelledby="wrapper-execution-policy-modifier-type"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Wrapper execution policy modifier type</h2><p>This policy type specifies that a worker should prepend a single path, and a number of arguments, to the execution of a subprocess to generate an action result. These arguments have a limited substitution mechanism that discovers any appearance of <code class="language-plaintext highlighter-rouge">&lt;property-name&gt;</code> and substitutes it with a string representation of a value currently available in the platform properties for the action. <em>If a specified <code class="language-plaintext highlighter-rouge">property-name</code> platform property is not present for the action, the wrapper is discarded entirely.</em> Note that this substitution does not apply to the <code class="language-plaintext highlighter-rouge">path</code> of the wrapper, which may point to any file with appropriate permissions - executable, and readable if necessary as a shell script, on linux, for example.</p><h3 id="example"> <a href="#example" class="anchor-heading" aria-labelledby="example"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Example:</h3><p>This example will use the buildfarm-provided executable <code class="language-plaintext highlighter-rouge">as-nobody</code>, which will upon execution demote itself to a <code class="language-plaintext highlighter-rouge">nobody</code> effective process owner uid, and perform an <code class="language-plaintext highlighter-rouge">execvp(2)</code> with the remaining provided program arguments, which will subsequently execute as a user that no longer matches the worker process.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># default wrapper policy application
execution_policies: {
  wrapper: {
    path: "/app/buildfarm/as-nobody"
  }
}
</code></pre></div></div><h2 id="action-specification"> <a href="#action-specification" class="anchor-heading" aria-labelledby="action-specification"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Action Specification</h2><p>An execution may be requested for an Action definition which includes the platform property <code class="language-plaintext highlighter-rouge">execution-policy</code>, which will select from the available execution policies present on a worker. A worker will not execute any action for which it does not have definitions matching its requested policies, similar to other platform requirements.</p><h2 id="built-in-execution-policies"> <a href="#built-in-execution-policies" class="anchor-heading" aria-labelledby="built-in-execution-policies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Built-in Execution Policies</h2><p>Buildfarm images are packaged with custom execution wrappers to be used as policies. Some of these wrappers are chosen dynamically based on the action. For example, the bazel-sandbox is included with buildfarm and can be chosen with <code class="language-plaintext highlighter-rouge">exec_property{"linux-sandbox": "True"}</code>. Below is a description of the execution wrappers provided:</p><h3 id="process-wrapper"> <a href="#process-wrapper" class="anchor-heading" aria-labelledby="process-wrapper"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> process-wrapper</h3><p>The process wrapper also used by bazel to allow Java to reliably kill processes. It is recommended this is used on all actions.</p><h3 id="linux-sandbox"> <a href="#linux-sandbox" class="anchor-heading" aria-labelledby="linux-sandbox"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> linux-sandbox</h3><p>The sandbox bazel uses when running actions client-side. This provides many isolations for actions such as tmpfs and block-network. It may also have performance issues. We include it with buildfarm to ensure additional consistency between local/remote actions.</p><h3 id="tini"> <a href="#tini" class="anchor-heading" aria-labelledby="tini"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> tini</h3><p>tini is a <a href="https://github.com/krallin/tini">a tiny but valid init for containers</a>. Depending on how buildfarm is containerized you may want to use.</p><h3 id="as-nobody"> <a href="#as-nobody" class="anchor-heading" aria-labelledby="as-nobody"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> as-nobody</h3><p>This is used to set the action’s user to “nobody”. Otherwise buildfarm will run the action as root which may be undesirable.</p><h3 id="skip_sleep-skip_sleeppreload--delay"> <a href="#skip_sleep-skip_sleeppreload--delay" class="anchor-heading" aria-labelledby="skip_sleep-skip_sleeppreload--delay"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> skip_sleep (skip_sleep.preload + delay)</h3><p>These wrappers are used for detecting actions that rely on time. Below is a demonstration of how they can be used. This addresses two problems in regards to an action’s dependence on time. The 1st problem is when an action takes longer than it should because it’s sleeping unnecessarily. The 2nd problem is when an action relies on time which causes it to eventually be broken on master despite the code not changing. Both problems are expressed below as unit tests. We demonstrate a time-spoofing mechanism (the re-writing of syscalls) which allows us to detect these problems generically over any action. The objective is to analyze builds for performance inefficiency and discover future instabilities before they occur.</p><h3 id="issue-1-slow-test"> <a href="#issue-1-slow-test" class="anchor-heading" aria-labelledby="issue-1-slow-test"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue 1 (slow test)</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
set -euo pipefail

echo -n "testing... "
sleep 10;
echo "done"
</code></pre></div></div><p>The test takes 10 seconds to run on average.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test --runs_per_test=10 --config=remote //cloud/buildfarm:sleep_test
//cloud/buildfarm:sleep_test                                             PASSED in 10.2s
  Stats over 10 runs: max = 10.2s, min = 10.1s, avg = 10.2s, dev = 0.0s
</code></pre></div></div><p>We can check for performance improvements by using the <code class="language-plaintext highlighter-rouge">skip-sleep</code> option.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test --runs_per_test=10 --config=remote --remote_default_exec_properties='skip-sleep=true' //cloud/buildfarm:sleep_test
//cloud/buildfarm:sleep_test                                             PASSED in 1.0s
  Stats over 10 runs: max = 1.0s, min = 0.9s, avg = 1.0s, dev = 0.0s
</code></pre></div></div><p>Now the test is 10x faster. If skipping sleep makes an action perform significantly faster without affecting its success rate, that would warrant further investigation into the action’s implementation.</p><h3 id="issue-2-future-failing-test"> <a href="#issue-2-future-failing-test" class="anchor-heading" aria-labelledby="issue-2-future-failing-test"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Issue 2 (future failing test)</h3><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
set -euo pipefail

CURRENT_YEAR=$(date +"%Y")
if [[ "$CURRENT_YEAR" -eq "2021" ]]; then
        echo "The year matches."
        date
        exit 0;
fi;
echo "Times change."
date
exit -1;
</code></pre></div></div><p>The test passes today, but will it pass tomorrow? Will it pass a year from now? We can find out by using the <code class="language-plaintext highlighter-rouge">time-shift</code> option.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel test --test_output=streamed --remote_default_exec_properties='time-shift=31556952' --config=remote //cloud/buildfarm:future_fail
INFO: Found 1 test target...
Times change.
Mon Sep 25 18:31:09 UTC 2023
//cloud/buildfarm:future_fail                                            FAILED in 18.0s
</code></pre></div></div><p>Time is shifted to the year 2023 and the test now fails. We can fix the problem before others see it.</p><hr><footer><p class="text-small text-grey-dk-100 mb-0"></p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/bazelbuild/bazel-buildfarm/edit/main/_site/docs/execution/execution_policies.md" id="edit-this-page">Edit on GitHub</a></p></div></footer></div></div><div class="search-overlay"></div></div>
